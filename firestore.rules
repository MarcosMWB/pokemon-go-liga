rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ===================== HELPERS ===================== */
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }

    // SUPERUSER: requer doc em superusers/{uid} (id do doc = UID)
    function isSuper() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/superusers/$(request.auth.uid));
    }

    // participante de match de trocas
    function isMatchParticipant(matchId) {
      return isSignedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/trocas_matches/$(matchId)).data.users;
    }

    // participante de DESAFIO (1×1)
    function isDesafioParticipant(desafioId) {
      let d = get(/databases/$(database)/documents/desafios_ginasio/$(desafioId));
      return isSignedIn() &&
        (d.data.lider_uid == request.auth.uid || d.data.desafiante_uid == request.auth.uid);
    }

    // usuário é líder do ginásio?
    function isGymLeader(ginasioId) {
      let g = get(/databases/$(database)/documents/ginasios/$(ginasioId));
      return isSignedIn() && g.data.lider_uid == request.auth.uid;
    }

    // inteiro não-decrescente
    function nonDecreasingInt(oldVal, newVal) {
      let oldInt = oldVal is int ? oldVal : 0;
      let newInt = newVal is int ? newVal : 0;
      return newInt >= oldInt;
    }

    /* ================ CONTAS / CADASTROS BÁSICOS ================ */

    match /superusers/{id} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSuper();
    }

    // PERFIL PÚBLICO (visível)
    match /usuarios_private/{uid} {
      allow read: if true;
      allow create: if isOwner(uid) || isSuper();

      // dono pode atualizar, mas sem elevar privilégios/campos sensíveis
      allow update: if isSuper() ||
        (
          isOwner(uid) &&
          (!('roles' in request.resource.data) || request.resource.data.roles == resource.data.roles) &&
          (!('verificado' in request.resource.data) || request.resource.data.verificado == resource.data.verificado) &&
          (!('isSuper' in request.resource.data) || request.resource.data.isSuper == resource.data.isSuper)
        );

      allow delete: if isSuper();
    }

    // PERFIL PRINCIPAL
    match /usuarios/{uid} {
      allow read: if true;

      // criar: próprio usuário ou super
      allow create: if isOwner(uid) || isSuper();

      // dono pode atualizar, com travas em campos sensíveis
      allow update: if isSuper() ||
        (
          isOwner(uid) &&
          (!('pontosPresenca' in request.resource.data) ||
            request.resource.data.pontosPresenca == resource.data.pontosPresenca) &&
          (!('pp_consumidos' in request.resource.data) ||
            nonDecreasingInt(resource.data.pp_consumidos, request.resource.data.pp_consumidos)) &&
          (!('verificado' in request.resource.data) ||
            request.resource.data.verificado == resource.data.verificado)
        );
      // allow delete: if isSuper();
    }

    match /consumoPP/{id} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    match /ligas/{id} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    match /temporadas/{id} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    /* ===================== GINÁSIOS ===================== */
    match /ginasios/{id} {
      allow read: if true;
      allow create, delete: if isSuper();
      allow update: if isSuper() || isGymLeader(id);
    }

    /* ========== RENÚNCIAS DE LIDERANÇA ========== */
    match /renuncias_ginasio/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.lider_uid == request.auth.uid;
      allow update, delete: if isSuper();
    }

    /* ========== DISPUTAS DE GINÁSIO (formato “evento/tabela”) ========== */
    match /disputas_ginasio/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() || isSuper();
      allow update, delete: if isSuper();
    }

    // coleção LEGADA de participantes de disputa (algumas telas antigas usam)
    match /disputas_ginasio_participantes/{id} {
      allow read: if isSignedIn();
      allow create: if (isSignedIn() && request.resource.data.usuario_uid == request.auth.uid) || isSuper();
      allow update: if isSignedIn() &&
        (resource.data.usuario_uid == request.auth.uid || isSuper());
      allow delete: if isSuper();
    }

    match /disputas_ginasio_resultados/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() &&
        request.resource.data.declarado_por == request.auth.uid;
      allow update: if isSignedIn() &&
        (resource.data.declarado_por != request.auth.uid || isSuper());
      allow delete: if isSuper();
    }

    /* ========== DESAFIOS (1×1) + CHAT (subcoleção) ========== */
    match /desafios_ginasio/{id} {
      allow read: if true;

      // só participantes criam (líder ou desafiante)
      allow create: if isSignedIn() && (
        request.resource.data.lider_uid == request.auth.uid ||
        request.resource.data.desafiante_uid == request.auth.uid
      );

      // participantes ou super podem atualizar
      allow update: if isDesafioParticipant(id) || isSuper();

      // remoção só super
      allow delete: if isSuper();

      match /mensagens/{msgId} {
        allow read: if isDesafioParticipant(id) || isSuper();
        allow create: if isDesafioParticipant(id) &&
          request.resource.data.from == request.auth.uid;
        allow delete: if isDesafioParticipant(id) || isSuper();
        allow update: if false;
      }
    }

    /* ====== HISTÓRICO / INSÍGNIAS / BLOQUEIOS / ALERTAS ====== */
    match /ginasios_liderancas/{id} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    match /insignias/{id} {
      allow read: if true;
      allow create: if (isSignedIn() &&
        request.resource.data.usuario_uid == request.auth.uid) || isSuper();
      allow update, delete: if isSuper();
    }

    match /bloqueios_ginasio/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSuper();
    }

    match /alertas_conflito/{id} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isSuper();
    }

    /* ===================== ELITE 4 / CAMPEONATOS ===================== */
    match /elite4/{id} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    match /elite4_mandatos/{id} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

      // FALTAVA ISTO:
      match /participantes/{uid} {
        allow read: if isSignedIn();
        allow create: if (isSignedIn() && request.resource.data.usuario_uid == request.auth.uid) || isSuper();
        allow update: if isSignedIn() && (resource.data.usuario_uid == request.auth.uid || isSuper());
        allow delete: if isSuper();
      }
      
    match /campeonatos_elite4/{id} {
      allow read: if isSignedIn();           // ou 'if true' se quiser totalmente público
      allow create, update, delete: if isSuper();

      match /participantes/{uid} {
        allow read: if isSignedIn();
        allow create: if (isSignedIn() && request.resource.data.usuario_uid == request.auth.uid) || isSuper();
        allow update: if isSignedIn() && (resource.data.usuario_uid == request.auth.uid || isSuper());
        allow delete: if isSuper();
      }
    }

    // COLEÇÃO LEGADA (plana) ainda lida por telas antigas/migração
    match /campeonatos_elite4_participantes/{id} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSuper();
    }

    /* ===================== TROCAS / RTS ===================== */
    match /trocas_ofertas/{id} {
      allow read, create, update: if isSignedIn();
    }

    match /trocas_swipes/{id} {
      allow read, create, update: if isSignedIn();
    }

    match /trocas_matches/{matchId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isMatchParticipant(matchId);

      match /mensagens/{msgId} {
        allow read, create, delete: if isMatchParticipant(matchId);
        allow update: if false;
      }
    }

    /* ===================== PONTOS DE PRESENÇA (PP) ===================== */
    match /pp_qr_sessions/{sessionId} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    match /pp_qr/{sessionId} {
      allow read: if true;
      allow create, update, delete: if isSuper();
    }

    match /pp_pontos/{uid} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSuper();
    }

    match /pp_registros/{regId} {
      function qrSession() {
        return get(/databases/$(database)/documents/pp_qr_sessions/$(request.resource.data.sessionId));
      }

      allow create: if
        (
          isSignedIn() &&
          request.resource.data.tipo == "qr" &&
          request.resource.data.user_uid == request.auth.uid &&
          request.resource.data.sessionId is string &&
          regId == (request.resource.data.sessionId + "_" + request.auth.uid) &&
          !exists(/databases/$(database)/documents/pp_registros/$(regId)) &&
          qrSession().exists() &&
          qrSession().data.ativo == true &&
          request.resource.data.userLat is number &&
          request.resource.data.userLng is number &&
          request.resource.data.userLat >= qrSession().data.minLat &&
          request.resource.data.userLat <= qrSession().data.maxLat &&
          request.resource.data.userLng >= qrSession().data.minLng &&
          request.resource.data.userLng <= qrSession().data.maxLng
        )
        ||
        (
          isSuper() &&
          request.resource.data.tipo == "manual" &&
          request.resource.data.user_uid is string
        );

      allow read: if isSignedIn() &&
        (resource.data.user_uid == request.auth.uid || isSuper());

      allow update, delete: if false;
    }

    /* ============== PP – LOGS VISUAIS ============== */
    match /pp_logs/{logId} {
      allow read: if isSignedIn() &&
        (resource.data.userId == request.auth.uid || isSuper());
      allow create: if isSignedIn() && isSuper() &&
        request.resource.data.userId is string;
      allow update, delete: if false;
    }

    /* ===================== VARIABLES (global) ===================== */
    function validVariablesData() {
      return request.resource.data.keys().hasOnly(['tempo_inscricoes', 'tempo_batalhas']) &&
             (request.resource.data.tempo_inscricoes is int) &&
             (request.resource.data.tempo_batalhas is int) &&
             request.resource.data.tempo_inscricoes >= 0 &&
             request.resource.data.tempo_batalhas >= 0 &&
             request.resource.data.tempo_inscricoes <= 24 * 14 &&
             request.resource.data.tempo_batalhas <= 24 * 14;
    }

    match /variables/{docId} {
      allow read: if isSignedIn();
      allow create, update: if isSuper() &&
        docId == "global" &&
        validVariablesData();
      allow delete: if isSuper() && docId == "global";
    }

    /* ===================== JOBS (Cloud Functions) ===================== */
    match /jobs_disputas/{jobId} {
      allow read, create, update, delete: if isSuper();
    }

    /* ===================== OUTROS ===================== */
    // coleção genérica 'participantes' (se ainda existir em telas antigas)
    match /{path=**}/participantes/{uid} {
      allow read: if isSignedIn();
      allow create: if (isSignedIn() && request.resource.data.usuario_uid == request.auth.uid) || isSuper();
      allow update: if isSignedIn() && (resource.data.usuario_uid == request.auth.uid || isSuper());
      allow delete: if isSuper();
    }

    match /participacoes/{id} { allow read, write: if isSignedIn(); }
    match /pokemon/{id}       { allow read, write: if isSignedIn(); }
    match /mensagens/{id}     { allow read, create, update: if isSignedIn(); }

    match /produtos_loja/{id} {
      allow read: if true;
      allow create, update: if isSuper();
    }
  }
}
